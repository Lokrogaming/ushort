<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JSON Shortener</title>
<link rel="stylesheet" href="styles/style.css">
</head>
<body>
<h1>JSON Shortener</h1>
<div class="card">
<h2>Neuen Vorschlag einreichen</h2>
<label>Art:</label>
<select id="type">
  <option value="url">URL</option>
  <option value="text">Text</option>
  <option value="image">Bild</option>
</select>
<label>Inhalt:</label>
<textarea id="content"></textarea>
<label>Deine E-Mail:</label>
<input id="userEmail" type="email" placeholder="deine@email"/>
<button id="checkBtn">Pr√ºfen & JSON erzeugen</button>
<div id="checkResult"></div>

<form id="submitForm" action="https://formsubmit.co/1fef705eaa4c4b325d68ff9616dbd6ea" method="POST" class="hidden">
  <input type="hidden" name="jsonData" id="jsonData"/>
  <input type="hidden" name="_redirect" value="https://lokrogaming.github.io/ushort"/>
  <p><input type="checkbox" id="agree"/> Ich stimme zu, dass mein Vorschlag per Mail gesendet wird.</p>
  <button id="submit">Senden</button>
</form>
</div>

<button id="darkmodeToggle">üåô</button>

<script>
let configData = {}, shortenData = {};

// Daten laden
async function loadData(){
  configData = await (await fetch("config.json")).json();
  shortenData = await (await fetch("shorten.json")).json();
  getUserCredits(); // Credits pr√ºfen/refillen
}

// Random-ID
function randomId(len = configData.formats.idLength){ 
  const chars = configData.formats.letters;
  let out = "";
  for(let i = 0; i < len; i++) out += chars.charAt(Math.floor(Math.random()*chars.length));
  return out;
}

// Code erstellen
function generateCode(type,id){ 
  return configData.formats.codeFormat
    .replace("${type}", type)
    .replace("${id}", id); 
}

// Eingaben pr√ºfen
async function validateInput(type,content){
  if(!content.trim()) return {ok:false,msg:"Inhalt darf nicht leer sein."};
  if(configData.forbiddenTypes.includes(type)) return {ok:false,msg:`Typ "${type}" nicht erlaubt.`};
  for(const w of configData.forbiddenWords){ 
    if(content.toLowerCase().includes(w.toLowerCase())) 
      return {ok:false,msg:`Enth√§lt verbotenes Wort: "${w}"`}; 
  }
  if(type==="url" && !/^https?:\/\//i.test(content)) 
    return {ok:false,msg:"Bitte g√ºltige URL angeben."};
  if(type==="image" && !(/^(https?:\/\/.+\.(png|jpe?g|gif|webp))$/i.test(content) || /^data:image\/.+;base64,/.test(content))) 
    return {ok:false,msg:"Bitte g√ºltige Bild-URL oder Base64."};
  return {ok:true};
}

// Credits aus LocalStorage verwalten
function getUserCredits() {
  const data = JSON.parse(localStorage.getItem("userCredits")) || {
    available: configData.codesPerUser,
    lastRefill: Date.now()
  };

  const now = Date.now();
  const oneDay = 24 * 60 * 60 * 1000;
  const daysPassed = Math.floor((now - data.lastRefill) / oneDay);

  if (daysPassed > 0) {
    data.available = Math.min(
      configData.codesPerUser,
      data.available + daysPassed * configData.codesPerDay
    );
    data.lastRefill = now;
    localStorage.setItem("userCredits", JSON.stringify(data));
  }
  return data;
}

function useCredit() {
  const data = getUserCredits();
  if (data.available > 0) {
    data.available--;
    localStorage.setItem("userCredits", JSON.stringify(data));
    return true;
  }
  return false;
}

// Pr√ºfen & JSON erzeugen
document.getElementById("checkBtn").addEventListener("click", async () => {
  const type = document.getElementById("type").value;
  const content = document.getElementById("content").value.trim();
  const userEmail = document.getElementById("userEmail").value.trim();
  const out = document.getElementById("checkResult"); 
  const form = document.getElementById("submitForm");

  out.textContent = "";
  form.classList.add("hidden");

  const valid = await validateInput(type, content);
  if(!valid.ok){ 
    out.innerHTML = `<p class="danger">${valid.msg}</p>`; 
    return; 
  }

  const credits = getUserCredits();
  if (credits.available <= 0) {
    out.innerHTML = "<p class='danger'>Du hast dein t√§gliches Limit erreicht. Bitte warte, bis Codes nachgef√ºllt werden.</p>";
    return;
  }

  let id, code, exists = true, tries = 0;
  while(exists && tries < 20){
    id = randomId();
    code = generateCode(type,id);
    exists = Boolean(shortenData[code]) || configData.reservedCodes.includes(code);
    tries++;
  }
  if(exists){ 
    out.innerHTML = "<p class='danger'>Konnte keinen freien Code finden.</p>"; 
    return; 
  }

  if (!useCredit()) {
    out.innerHTML = "<p class='danger'>Keine Credits verf√ºgbar.</p>";
    return;
  }

  const json = {type, code, content, userEmail};
  document.getElementById("jsonData").value = JSON.stringify(json,null,2);
  out.innerHTML = `<p class="success">Code erzeugt: ${code}. Bitte best√§tigen und absenden.</p>`;
  form.classList.remove("hidden");
});

// Submit pr√ºfen ob Checkbox gesetzt
document.getElementById("submitForm").addEventListener("submit", (e) => {
  const agree = document.getElementById("agree");
  const out = document.getElementById("checkResult");
  if (!agree.checked) {
    e.preventDefault();
    out.innerHTML = `<p class="danger">Bitte best√§tige das Senden der Daten!</p>`;
  }
});

// Darkmode
const toggleBtn = document.getElementById("darkmodeToggle");
document.documentElement.setAttribute("data-theme", localStorage.getItem("theme")||"light");
toggleBtn.textContent = localStorage.getItem("theme")==="dark" ? "‚òÄÔ∏è" : "üåô";
toggleBtn.addEventListener("click",()=>{
  const newTheme = document.documentElement.getAttribute("data-theme")==="dark" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", newTheme);
  localStorage.setItem("theme", newTheme);
  toggleBtn.textContent = newTheme==="dark" ? "‚òÄÔ∏è" : "üåô";
});

loadData();
</script>

</body>
</html>
